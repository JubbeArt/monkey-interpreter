folder = "./.downloads"

func download_thread(thread)
	sub = thread.sub or ""
	com = thread.com or ""
	full = sub+com

	if not str.has(full, "straigh") or not str.has(full, "shota") then
		return
	end

	res = http.get("https://4.cdn.org/b/thread/#{thread.id}.json")

	arr.each(res.posts, func (post)
		if not post.ext then return end
		if fs.exists(path.join(folder, thread.id, thread.id+thread.ext) then return end

		http.download(
			"https://4.cdn.org/b/#{thread.id}#{thread.ext}",
			path.join(folder, thread.id)
		)
	end)
end

loop
    # each environment has a error handle
    error e
        log.error(e)
        print("error", e)
        time.sleep(60*5)
    end

	log.info("")

	res = http.get("https://4.cdn.org/b/catalog.json")

	threads = arr.map(res, func (page)
		return page.pages
	end)

	threads = arr.flatten(threads)

	arr.filter(threads, download_thread)

	time.sleep(60*5)
end

